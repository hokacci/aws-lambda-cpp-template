# aws-lambda-cpp-template

[➥英語版: English Version](README.md)

## Why & What

C++でLambda関数を書くことで、効率的に計算を行いたいときがある。  
何度も呼ばれる処理や計算コストの高い処理をC++で書くことで、うまくやれば計算にかかる料金を安く上げることができる。  
しかし、C++でLambda関数を書くのはあまり一般的ではないのか、環境の立ち上げに時間がかかりがちである。  
そこで、C++でLambda関数のプロジェクトを迅速に立ち上げるためのテンプレートプロジェクトとして、これを用意した。

## 精神

- 完全さより簡潔さを好む
- 一つの設定ファイルを開発者が編集することでテンプレートが完成するのではなく、全てのファイルを開発者が自由に変更できるようにする (C++の開発者にとっては多くの場合、奇妙なyamlファイルを編集するより、見慣れたファイルを編集するほうが楽である)
- ビルド用のコンテナイメージのサイズを頑張って小さくするようなことはしない

## 必要なツール

- make: 色々なタスクをmakeで記述しているので必要
- docker: docker内でビルドを行うのに必要
- aws cli: 簡易にデプロイ・テストを行うのに必要・しないなら不要

## 最初にやること = プロジェクト名を変更する

以下の2箇所で設定する。

```
makefile:3 PROJECT_NAME = example-project
```

```
CMakeLists.txt:4 project(example-project LANGUAGES CXX)
```

## セットアップする

ビルドを行うためのDockerイメージをビルドする。

```
make setup
```

## ビルドする

エフェメラルなDockerコンテナ内でビルドが行われる。

```
make
```

成果物は`build/${PROJECT_NAME}.zip`にできる。

## デプロイする (最初のみ)

簡易なデプロイ機能を提供する。  
本格的なものではない。  
最小権限原則に沿わないIAMポリシーを作成するため、これが問題になる場合は、マネジメントコンソール上で自前で作成したり、IaC統合を自分で考えて作成すること。

```
make deploy-init
```

ログは`deploy.log`に追記される。要チェック。

## デプロイした関数をテストする

`test/test.json`を入力にして、デプロイされたLambda関数を起動し、レスポンスを`test-response.json`に、ログを`test.log`に書き出す。

```
make test-lambda
```

## ソースコードを編集する

`src/`以下のコードを編集すればOK。  
ファイルの追加／削除は、`CMakeLists.txt`に反映すること。  
面倒くさがるなら、globを使用しても良い。自由。

## ライブラリを追加

`docker/Dockerfile`を編集してビルド環境にインストールし、`CMakeLists.txt`を編集すればOK。

Dockerfileを編集した場合は、`make setup`を再度行うことを忘れずに。


## 更新をデプロイする

```
make deploy-update
```

ログは`deploy.log`に追記される。要チェック。


## VSCodeの補完機能を使いながら開発する

VSCodeでの開発を強制する意図はない。自由である。
非常に単純な方法の一例として、以下のコマンドが用意されている。

以下で開発用のコンテナが起動するので、リモートエクスプローラー -> Containers -> [project name]-devenvにアタッチして、`/workspace`を開けばOK。  
コンテナ内でC++の拡張機能を入れれば最低限の補完は効くようになる。

```
make devenv-init
```

開発用コンテナを落とすときは、

```
make devenv-down
```

立ち上げ直すときは、

```
make devenv-up
```

などとする。

コンテナ内でのビルドは、

```
make build-local
```

とする。

`~/.aws`をホストとコンテナで共有すれば、デプロイやテストもコンテナ内で出来るようになるが、そこまで拘る必要もないだろう。
